# AthenSafe
AndroidStudio Project , ReadMe file

Γεράσιμος Μάγκος 
Αικατερίνη Παλαιολόγου
Ιωάννα Καρδαρά


Υπολογισμός και Ομαδοποίηση Στατιστικών Επικινδυνότητας(στην MapsActivity)
1. Λογική Υπολογισμού Ποσοστού Επικινδυνότητας
Ο υπολογισμός του ποσοστού επικινδυνότητας για κάθε περιοχή γίνεται σε δύο βασικά βήματα:
•	Βήμα 1: Μέτρηση Περιστατικών και Συνολικού Βάρους Επικινδυνότητας
o	Όταν λαμβάνονται νέα δεδομένα από τη Firebase (onDataChange()): 
	Για κάθε περιστατικό, διαβάζονται οι συντεταγμένες και το βάρος επικινδυνότητας.
	Οι συντεταγμένες μετατρέπονται σε όνομα περιοχής με τη μέθοδο getArea().
	Αν βρεθεί η περιοχή, αυξάνεται ο μετρητής περιστατικών για την περιοχή (incidentCounts) και το συνολικό βάρος όλων των περιοχών (totalWeight). Επίσης, αυξάνεται ο συνολικός αριθμός περιστατικών (totalIncidents).
•	Βήμα 2: Υπολογισμός Ποσοστού Επικινδυνότητας για Κάθε Περιοχή
o	Αφού επεξεργαστούν όλα τα περιστατικά: 
	Για κάθε περιοχή, καλείται η μέθοδος calculateAreaWeight() για να βρεθεί το συνολικό βάρος των περιστατικών της συγκεκριμένης περιοχής.
	Το ποσοστό επικινδυνότητας υπολογίζεται ως: dangerPercentage = (areaWeight / totalWeight) * 100
	Αυτό αποθηκεύεται στον χάρτη areaDangerPercentages.
Τι επηρεάζει το ποσοστό επικινδυνότητας;
•	Το βάρος των περιστατικών (π.χ., σοβαρότητα) επηρεάζει άμεσα.
•	Ο αριθμός των περιστατικών δεν επηρεάζει άμεσα το ποσοστό, παρά μόνο μέσω του συνολικού τους βάρους.
•	Συνοπτικά: Μια περιοχή με λιγότερα αλλά πιο βαριά περιστατικά μπορεί να έχει υψηλότερο ποσοστό επικινδυνότητας από μια περιοχή με πολλά αλλά ήπια περιστατικά.







2. Ομαδοποίηση και Εμφάνιση Δεδομένων (Μέθοδος toggleMarkers()  line 933 MapActivity)
🔍 Ανάλυση βήμα-βήμα
📍 1️.Αν οι markers είναι ήδη ορατοί:
•	Για κάθε marker στη λίστα areaMarkers, καλεί marker.remove() για να τους αφαιρέσει από το χάρτη.
•	Καθαρίζει τη λίστα areaMarkers.
•	Ορίζει markersVisible = false (δεν φαίνονται πλέον οι markers).
________________________________________
📍 2️.Αν οι markers δεν είναι ορατοί:
•	Προετοιμάζει δεδομένα:
o	markerOptionsList: Λίστα με MarkerOptions για το όνομα της περιοχής (σύντομο).
o	markerOptionsList2: Λίστα με MarkerOptions για το πλήρες όνομα περιοχής (backup).
o	areasWithIncidents: Set με τα ονόματα περιοχών που έχουν περιστατικά.
________________________________________
📍 3️.Δημιουργία Markers για περιοχές με περιστατικά:
Για κάθε περιοχή στο incidentCounts:
•	Παίρνει το όνομα περιοχής (area), τον αριθμό περιστατικών (count), το LatLng κέντρο και το ποσοστό επικινδυνότητας.
•	Αν βρει δεδομένα:
o	Δημιουργεί ένα custom icon (κόκκινο info_icon σε bitmap).
o	Κάνει επεξεργασία ονόματος περιοχής: προσπαθεί να εξάγει μικρότερο όνομα από την πλήρη διεύθυνση.
o	Φτιάχνει δύο MarkerOptions:
	Το πρώτο (markerOptionsList) με το σύντομο όνομα.
	Το δεύτερο (markerOptionsList2) με το πλήρες όνομα (για εσωτερική χρήση).
o	Τα προσθέτει στις αντίστοιχες λίστες.
________________________________________
📍 4️. Δημιουργία Markers για περιοχές χωρίς περιστατικά:
•	Για κάθε περιοχή στην athensAreas (όλες οι περιοχές):
o	Αν δεν είναι στη λίστα με περιστατικά (areasWithIncidents), δημιουργεί ένα marker με απλό εικονίδιο και την περιγραφή  (safetyLevel).
________________________________________
📍 5️.Ομαδοποίηση Markers που είναι κοντά(groupMarkersByDistance θα την αναλύσουμε παρακάτω):
•	Χρησιμοποιεί groupMarkersByDistance() για να ομαδοποιήσει τους markers που είναι κοντά (απόσταση < 100 μέτρα).
•	Κάνει το ίδιο για τις δύο λίστες: markerOptionsList (για εμφάνιση) και markerOptionsList2 (για πλήρη ονόματα).
________________________________________
📍 6️. Δημιουργία Markers για κάθε Ομάδα:
Για κάθε ομάδα:
•	Αν έχει μόνο 1 marker, το προσθέτει απευθείας στο χάρτη.
•	Αν έχει πολλούς markers(ομάδα):
o	Υπολογίζει:
	Κέντρο της ομάδας (LatLng).
	Σύνολο περιστατικών.
	Μέσο ποσοστό επικινδυνότητας.
	Συγκεντρώνει τις ώρες περιστατικών για να βρει την πιο επικίνδυνη ώρα (π.χ., 22:00).
o	Φτιάχνει νέο marker για την ομάδα, με το ομαδοποιημένο όνομα και συνοπτικά στατιστικά.
________________________________________
📍 7️.Προσθήκη OnClick Listener:
•	Όταν κάνεις κλικ σε ένα marker, ελέγχει:
o	Αν το tag του marker είναι String → δείχνει λεπτομέρειες για μία περιοχή.
o	Αν το tag είναι λίστα (List) → δείχνει λεπτομέρειες για ομαδοποιημένους markers-περιστατικά.

🗂 Τι κάνει η μέθοδος groupMarkersByDistance  line 1203 MapsActivity
Η μέθοδος ομαδοποιεί σημεία (markers) που βρίσκονται κοντά μεταξύ τους στον χάρτη.
👉 Συγκεκριμένα, αν δύο σημεία απέχουν λιγότερο από μια συγκεκριμένη απόσταση (π.χ. 100 μέτρα), τότε θεωρούνται μέλη της ίδιας ομάδας.

🛠️ Πώς το κάνει 
Δημιουργείται μια κενή λίστα, η groupedMarkers, η οποία θα αποθηκεύσει τις τελικές ομάδες των markers.
Δημιουργείται ένα αντίγραφο της αρχικής λίστας markerOptionsList που ονομάζεται remainingMarkers. Αυτή η λίστα θα χρησιμοποιηθεί για να παρακολουθεί ποιους markers-περιστατικά δεν έχουν ακόμα ομαδοποιηθεί.
Βρόχος Ομαδοποίησης (while loop):

Ο κώδικας εκτελείται όσο υπάρχουν markers στη λίστα remainingMarkers (δηλαδή, όσο υπάρχουν markers που δεν έχουν ακόμα τοποθετηθεί σε κάποια ομάδα).
Δημιουργία Νέας Ομάδας:
Σε κάθε επανάληψη, δημιουργείται μια νέα κενή λίστα group για την τρέχουσα ομάδα.
Ο πρώτος marker από τη λίστα remainingMarkers αφαιρείται και προστίθεται ως ο αρχικός (firstMarker) στην τρέχουσα group. Αυτός ο firstMarker θα είναι το σημείο αναφοράς για την τρέχουσα ομάδα.
Εύρεση Markers για την Τρέχουσα Ομάδα (for loop):
Δημιουργείται μια προσωρινή λίστα markersToRemove. Αυτή θα κρατήσει τους markers που θα βρεθούν ότι ανήκουν στην τρέχουσα ομάδα και πρέπει να αφαιρεθούν από το remainingMarkers.
Ο κώδικας κάνει επανάληψη σε όλους τους υπόλοιπους markers που βρίσκονται ακόμα στο remainingMarkers.
Για κάθε otherMarker που εξετάζεται, υπολογίζεται η απόσταση μεταξύ του firstMarker (του σημείου αναφοράς της τρέχουσας ομάδας) και του otherMarker. Υποθέτουμε ότι υπάρχει μια συνάρτηση Distance() που κάνει αυτόν τον υπολογισμό.
Έλεγχος Απόστασης: Αν η υπολογιζόμενη απόσταση είναι μικρότερη ή ίση από το distanceThreshold:
Ο otherMarker προστίθεται στην τρέχουσα group.
Ο otherMarker προστίθεται επίσης στη λίστα markersToRemove, για να αφαιρεθεί αργότερα από το remainingMarkers.
Ενημέρωση Remaining Markers:
Αφού ολοκληρωθεί ο εσωτερικός βρόχος for, όλοι οι markers που βρέθηκαν ότι ανήκουν στην τρέχουσα ομάδα (δηλαδή αυτοί που προστέθηκαν στο markersToRemove) αφαιρούνται από τη λίστα remainingMarkers. Αυτό διασφαλίζει ότι αυτοί οι markers δεν θα επανεξεταστούν σε μελλοντικές ομάδες.
Προσθήκη Ομάδας:
Η πλήρης group (που περιέχει τον firstMarker και όλους τους markers που βρέθηκαν κοντά του) προστίθεται στην τελική λίστα groupedMarkers.
Επιστροφή Αποτελέσματος:
Όταν η λίστα remainingMarkers γίνει κενή (δηλαδή, όλοι οι markers έχουν ομαδοποιηθεί), η συνάρτηση επιστρέφει τη λίστα groupedMarkers που περιέχει όλες τις δημιουργημένες ομάδες.












🌐 Ροή Επικοινωνίας με το Dialogflow
________________________________________
🧩 Κύριες Κλάσεις & Ρόλοι:
•	ChatActivity:
➔ Παίρνει το μήνυμα του χρήστη
➔ Καλεί sendMessageToDialogflow()
•	DialogflowRequest:
➔ Πακέτο με δεδομένα (μήνυμα, γλώσσα) προς το Dialogflow
•	DialogflowClient:
➔ Παρέχει το DialogflowService
➔ Διαχειρίζεται το access token
•	DialogflowService:
➔ Retrofit interface – Ορίζει endpoint και headers
➔ Στέλνει το HTTP POST request(προς Dialogflow endpoint)
•	RetrofitClient:
➔ Εκτελεί την HTTP κλήση
➔ Μετατρέπει JSON ↔ Java Objects (μέσω Gson)
•	Dialogflow API:
➔ Λαμβάνει το αίτημα
➔ Επεξεργάζεται intents, δημιουργεί απάντηση
________________________________________
🔁 Ροή Δεδομένων (Βήμα-Βήμα):
	Χρήστης ➔ Γράφει μήνυμα στην ChatActivity
	
ChatActivity ➔ Δημιουργεί DialogflowRequest
	
 ChatActivity ➔ Καλεί DialogflowService.sendMessage() μέσω DialogflowClient
	
 RetrofitClient ➔ Στέλνει HTTP POST με Access Token & JSON
	
Dialogflow API ➔ Επεξεργάζεται, δημιουργεί JSON Response
	
RetrofitClient ➔ Παίρνει JSON, μετατρέπει σε DialogflowResponse
	
ChatActivity ➔ Λαμβάνει DialogflowResponse μέσω callback
	
Εμφανίζει απάντηση στη λίστα messageList

REROUTING ( στην MapsActivity)
Η εφαρμογή υλοποιεί μηχανισμό επιλογής της ασφαλέστερης διαδρομής με βάση δεδομένα επικινδυνότητας (π.χ. περιστατικά) και, εάν δεν βρεθεί πλήρως ασφαλής διαδρομή, επιλέγει τη λιγότερο επικίνδυνη.
Ο αλγόριθμος ελέγχει όλα τα βήματα των πιθανών διαδρομών (από το Directions API της Google) και επιλέγει αυτήν που δεν περνάει κοντά σε δηλωμένα περιστατικά, χρησιμοποιώντας γεωγραφικούς ελέγχους απόστασης.
•  Αν βρεθεί διαδρομή που δεν περνά από καμία επικίνδυνη τοποθεσία, επιλέγεται αυτή.
•  Αν όλες περνούν από επικίνδυνα σημεία, γίνεται επιλογή της λιγότερο επικίνδυνης (πρώτη που επιστρέφει το API).
•  Υπάρχει fallback μηχανισμός ώστε να μην κολλάει η εφαρμογή σε αδιέξοδες περιπτώσεις.

🔁 Ροή εκτέλεσης – Περιγραφή ροής μεθόδων
🔁 Ροή Εκτέλεσης:
1.	geocodeAndShowRoute(String address)  line 1659
Ο χρήστης εισάγει μια διεύθυνση ➜ γίνεται μετατροπή σε LatLng ➜ καλείται getHeatmapData() για να φορτωθούν τα περιστατικά ➜ μέσω callback, καλείται showSafeRoute().
2.	showSafeRoute(LatLng destination)  line 1813
Ελέγχει αν ο προορισμός είναι κοντά σε επικίνδυνα σημεία με isDestinationNearIncident().
➤ Αν ναι: Προβάλλεται προειδοποίηση στον χρήστη.
➤ Αν όχι ή αν ο χρήστης συνεχίσει ➜ καλείται getSafeDirections().
3.	getSafeDirections(LatLng origin, LatLng destination)  line 1884
Λαμβάνονται εναλλακτικές διαδρομές από το Google Directions API (alternatives(true)).
➤ Η μέθοδος findSafeRoute() αναλύει κάθε διαδρομή για επικινδυνότητα.
4.	findSafeRoute(...)
➤ Αναλύει κάθε διαδρομή σε επιμέρους βήματα (steps).
➤ Ελέγχει με isPointNearIncident(...) αν τμήματα της διαδρομής περνούν σε απόσταση ≤50m από περιστατικά.
➤ Αν βρεθεί διαδρομή χωρίς επικίνδυνα σημεία ➜ επιλέγεται ως ασφαλής.
➤ Αν όλες είναι επικίνδυνες ➜ επιλέγεται η πρώτη ως fallback.
5.	openRouteInGoogleMaps(List<LatLng> points)  line 2065
➤ Δημιουργείται URL για Google Maps με waypoints.
➤ Ανοίγει intent για προβολή της διαδρομής στον χρήστη.


ΠΙΟ ΑΝΑΛΥΤΙΚΑ

________________________________________
✅ 1. geocodeAndShowRoute(String address)
Η μέθοδος αυτή καλείται όταν ο χρήστης πληκτρολογεί μια διεύθυνση και πατά "Αναζήτηση".
🔹 Χρησιμοποιεί τον Geocoder για να μετατρέψει τη διεύθυνση σε συντεταγμένες (LatLng).
🔹 Πριν απ’ αυτό, όμως, καλεί την:
🔸 getHeatmapData(...)
➤ Φορτώνει τα δεδομένα των περιστατικών (heatmap/incident points) και μέσω callback επιστρέφει στη μέθοδο:
🔸 onHeatmapDataReceived(...)
➤ Μόλις ληφθούν τα δεδομένα heatmap:
▪ Εντοπίζεται η πλησιέστερη διεύθυνση στη χώρα του χρήστη
▪ Δημιουργείται LatLng destination για την επιλεγμένη τοποθεσία
➤ Τέλος, καλεί τη μέθοδο:
________________________________________
✅ 2. showSafeRoute(LatLng destination)
Στόχος: να ελέγξει αν ο προορισμός είναι κοντά σε περιστατικά και να συνεχίσει με ασφαλή διαδρομή.
🔹 Αν υπάρχει userMarker, δηλαδή γνωρίζουμε την τρέχουσα θέση του χρήστη, τότε:
🔸 Καλείται:
🔸 isDestinationNearIncident(destination)
➤ Υπολογίζει αν κάποιο περιστατικό βρίσκεται σε απόσταση ≤ 50m από τον προορισμό.
➤ Αν ναι, εμφανίζεται AlertDialog για να ρωτήσει τον χρήστη αν θέλει να συνεχίσει.
➤ Αν όχι, καλείται κατευθείαν η επόμενη μέθοδος:
________________________________________
✅ 3. getSafeDirections(LatLng origin, LatLng destination)
🔹 Χρησιμοποιεί το Google Directions API για να λάβει εναλλακτικές διαδρομές.
🔸 Η εκτέλεση γίνεται σε background thread, και το αποτέλεσμα (DirectionsResult) παραλαμβάνεται μέσω:
🔸 req.await()
➤ Μόλις ληφθεί το αποτέλεσμα, καλείται η μέθοδος:
________________________________________
✅ 4. findSafeRoute(DirectionsResult, origin)
🔹 Ελέγχει κάθε προτεινόμενη διαδρομή από το Google.
🔸 Υπολογίζει την εγγύτητα των σημείων της διαδρομής προς περιστατικά.
🔸 Επιλέγει την πιο "ασφαλή" διαδρομή.
🔸 Επιστρέφει λίστα safeRoutePoints (List<LatLng>).

•	Δεν υπολογίζει ποσοτικά ποια είναι λιγότερο επικίνδυνη.
•	Απλώς απορρίπτει διαδρομές που έχουν "επικίνδυνα" τμήματα (μέσω της isPointNearIncident(...)).
•	Αν καμία δεν είναι "ασφαλής", τότε παίρνει την πρώτη ως fallback χωρίς ανάλυση πόσο επικίνδυνη είναι.
Κοιτάει κάθε leg και κάθε step (δηλαδή κάθε μικρό κομμάτι της διαδρομής). Ελέγχει αν κάποιο τμήμα είναι επικίνδυνο. Αν βρεθεί τουλάχιστον μία "ασφαλής" διαδρομή → επιστρέφεται αυτή.
Αλλιώς → κρατά την πρώτη που είδε ως fallback.

________________________________________
↩ Επιστροφή στη getSafeDirections:
🔸 Αν η safeRoutePoints δεν είναι null, σχεδιάζει τη διαδρομή στον χάρτη με PolylineOptions.
🔸 Εμφανίζει marker προορισμού.
________________________________________
✅ 5. openRouteInGoogleMaps(safeRoutePoints)
🔹 Δημιουργεί Intent με waypoints για να ανοίξει το Google Maps
🔸 Αν ο αριθμός σημείων είναι εντός ορίου (23 waypoints max), εμφανίζεται διαδρομή στο Google Maps.



